# @configure_input@

VPATH=@srcdir@
srcdir=@srcdir@
SRCPFX=$(srcdir)/
SRCPFX_INCPATH=-I$(srcdir)/denser -I$(srcdir)/libsnet -I$(srcdir)

prefix=@prefix@
exec_prefix=@exec_prefix@
MANDIR=/usr/share/man
BINDIR=@bindir@
ETCDIR=@sysconfdir@/simta
SBINDIR=@sbindir@
LIBEXECDIR=@libexecdir@/simta
spool=/var/spool
SPOOLDIR=$(spool)/simta/
LOCAL_Q=${SPOOLDIR}local
SLOW_Q=${SPOOLDIR}slow
FAST_Q=${SPOOLDIR}fast
DEAD_Q=${SPOOLDIR}dead
SIMTA_ETC=${SPOOLDIR}etc
SIMTA_COMMAND=${SPOOLDIR}command

SRC=    @LDAP_SRC@ @SSL_SRC@ \
	daemon.c receive.c argcargv.c envelope.c base64.c \
	simsend.c simconnect.c rcptlist.c address.c \
	simalias.c bounce.c wildcard.c
COMMONOBJ=	@LDAP_OBJ@ @SSL_OBJ@ \
		address.o argcargv.o base64.o bdb.o bounce.o envelope.o \
		expand.o header.o line_file.o ll.o ml.o mx.o q_cleanup.o \
		queue.o red.o simta.o smtp.o wildcard.o
SIMTAOBJ=	${COMMONOBJ} daemon.o receive.o
SIMCONOBJ=	${COMMONOBJ} simconnect.o
SIMCOBJ=	${COMMONOBJ} simc.o
SIMDAOBJ=	simda.o
SIMSENDOBJ=	${COMMONOBJ} simsend.o
SIMLOGOBJ=	simlog.o
EXPANDEROBJ=	${COMMONOBJ} expander.o
SIMRBLOBJ=	${COMMONOBJ} simrbl.o
SIMREVERSEOBJ=	${COMMONOBJ} simreverse.o
QRUNNEROBJ=	${COMMONOBJ} q_runner.o
QCLEANUPOBJ=	${COMMONOBJ} q_cleanup.o
SIMALIASOBJ=	${COMMONOBJ} simalias.o
SLAOBJ=		sla.o
SIMCKOBJ=	simck.o base64.o md.o

CC=		@CC@
OPTOPTS=	@OPTOPTS@
INSTALL=	@INSTALL@
INCPATH=	-I. -Idenser -Ilibsnet @CPPFLAGS@ @BDB_CPPFLAGS@ @LIBSSL_CPPFLAGS@ @LDAP_CPPFLAGS@ @LIBWRAP_CPPFLAGS@ @LIBSASL_CPPFLAGS@${SRCPFX_INCPATH}
DEFS=		-g -DLIBEXECDIR=\"$(LIBEXECDIR)\" @DEFS@
LIBPATH=	-Ldenser -Llibsnet/.libs @LDFLAGS@ @BDB_LDFLAGS@ @LIBSSL_LDFLAGS@ @LDAP_LDFLAGS@ @LIBWRAP_LDFLAGS@ @LIBSASL_LDFLAGS@
LIBS=		-ldnsr -lsnet @LIBS@ @EXTRALIBS@
TAGSFILE=	tags
CFLAGS=		${DEFS} ${OPTOPTS} ${INCPATH}

SIMTALIBPATH=	${LIBPATH}
SIMTALIBS=	${LIBS}

MAN1TARGETS=	simsendmail.1
MAN8TARGETS=	simta.8
BINTARGETS=	simrbl simreverse simalias simexpander denser/dense simconnect
TARGETS=	simta simconnect simsendmail q_runner simexpander \
                sla simc simda \
		${BINTARGETS}

all : ${TARGETS}

install : all FRC
	@mkdir -p ${DESTDIR}${SBINDIR} ${DESTDIR}${BINDIR} ${DESTDIR}${LIBEXECDIR} ${DESTDIR}${MANDIR}/man1 ${DESTDIR}${MANDIR}/man8 ${DESTDIR}$(spool)
	${INSTALL} -m 0750 @SUID_OWNER@ -d ${DESTDIR}${SPOOLDIR} ${DESTDIR}${LOCAL_Q} ${DESTDIR}${SLOW_Q} ${DESTDIR}${FAST_Q} ${DESTDIR}${DEAD_Q} ${DESTDIR}${SIMTA_ETC} ${DESTDIR}${SIMTA_COMMAND}
	${INSTALL} -m 755 -c simta ${DESTDIR}${SBINDIR}/
	${INSTALL} -m 6755 @SUID_OWNER@ -c simsendmail ${DESTDIR}${SBINDIR}/
	${INSTALL} -m 6755 @SUID_OWNER@ -c simc ${DESTDIR}${SBINDIR}/
	${INSTALL} -m 6750 -c simda ${DESTDIR}${LIBEXECDIR}/
	for i in ${BINTARGETS}; do \
	    ${INSTALL} -m 0755 -c $$i ${DESTDIR}${BINDIR}; \
	done
	ln -f ${DESTDIR}${SBINDIR}/simsendmail ${DESTDIR}${SBINDIR}/sendmail
	for i in ${MAN1TARGETS}; do \
	    ${INSTALL} -m 0644 -c ${SRCPFX}$$i ${DESTDIR}${MANDIR}/man1/; \
	done
	for i in ${MAN8TARGETS}; do \
	    ${INSTALL} -m 0644 -c ${SRCPFX}$$i ${DESTDIR}${MANDIR}/man8/; \
	done

simta : stamp-libsnet stamp-denser ${SIMTAOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simta ${SIMTAOBJ} ${SIMTALIBPATH} ${SIMTALIBS}

simck : stamp-libsnet ${SIMCKOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simck ${SIMCKOBJ} \
		${SIMTALIBPATH} ${SIMTALIBS}

sla : stamp-libsnet ${SLAOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o sla ${SLAOBJ} \
		${SIMTALIBPATH} ${SIMTALIBS}

simc : ${SIMCOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simc ${SIMCOBJ} \
		${SIMTALIBPATH} ${SIMTALIBS}

simda : ${SIMDAOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simda ${SIMDAOBJ}

simsendmail : stamp-libsnet stamp-denser ${SIMSENDOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simsendmail ${SIMSENDOBJ} \
		${SIMTALIBPATH} ${SIMTALIBS}

simalias : ${SIMALIASOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simalias ${SIMALIASOBJ} ${SIMTALIBPATH} \
	${SIMTALIBS}

simlog : stamp-libsnet stamp-denser ${SIMLOGOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simlog ${SIMLOGOBJ} ${LIBPATH} ${LIBS}

simexpander : stamp-libsnet stamp-denser ${EXPANDEROBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simexpander ${EXPANDEROBJ} ${SIMTALIBPATH} ${SIMTALIBS}

simrbl : stamp-libsnet stamp-denser ${SIMRBLOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simrbl ${SIMRBLOBJ} ${SIMTALIBPATH} ${SIMTALIBS}

simreverse : stamp-libsnet stamp-denser ${SIMREVERSEOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simreverse ${SIMREVERSEOBJ} ${SIMTALIBPATH} ${SIMTALIBS}

simconnect : stamp-libsnet stamp-denser ${SIMCONOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simconnect ${SIMCONOBJ} ${SIMTALIBPATH} ${SIMTALIBS}

q_runner : stamp-libsnet stamp-denser ${QRUNNEROBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o q_runner ${QRUNNEROBJ} ${SIMTALIBPATH} ${SIMTALIBS}

q_cleanup : stamp-libsnet stamp-denser ${QCLEANUPOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o q_cleanup ${QCLEANUPOBJ} ${LIBPATH} ${LIBS}

address.o: bdb.h config.h envelope.h expand.h header.h line_file.h ll.h mx.h queue.h red.h simta.h simta_ldap.h
argcargv.o: argcargv.h config.h
base64.o: base64.h config.h
bdb.o: bdb.h config.h
bounce.o: config.h envelope.h expand.h line_file.h ll.h ml.h queue.h simta.h smtp.h
daemon.o: config.h envelope.h ll.h queue.h simta.h tls.h
dn.o: dn.h
envelope.o: config.h envelope.h header.h line_file.h ll.h queue.h simta.h
expand.o: config.h dn.h envelope.h expand.h header.h line_file.h ll.h queue.h simta.h simta_ldap.h
expander.o: config.h envelope.h expand.h line_file.h ll.h ml.h queue.h simta.h smtp.h
header.o: config.h envelope.h header.h line_file.h queue.h simta.h
line_file.o: config.h line_file.h
ll.o: config.h ll.h
md.o: base64.h config.h simta.h
ml.o: config.h envelope.h line_file.h ml.h queue.h simta.h
mx.o: config.h envelope.h expand.h ll.h mx.h queue.h red.h simta.h
q_cleanup.o: config.h envelope.h ll.h queue.h simta.h
q_runner.o: config.h envelope.h expand.h line_file.h ll.h ml.h queue.h simta.h smtp.h
queue.o: config.h envelope.h expand.h line_file.h ll.h ml.h mx.h queue.h red.h simta.h smtp.h wildcard.h
receive.o: argcargv.h base64.h bdb.h config.h envelope.h expand.h header.h line_file.h ll.h md.h mx.h queue.h red.h simta.h simta_ldap.h
red.o: argcargv.h config.h envelope.h expand.h ll.h ml.h mx.h queue.h red.h simta.h simta_ldap.h
simalias.o: argcargv.h bdb.h config.h envelope.h expand.h ll.h ml.h mx.h queue.h red.h simta.h simta_ldap.h
simck.o: base64.h config.h md.h
simlog.o: config.h simta.h
simrbl.o: config.h envelope.h ll.h mx.h simta.h
simreverse.o: config.h envelope.h ll.h mx.h simta.h
simsend.o: config.h envelope.h header.h line_file.h queue.h simta.h
simta.o: argcargv.h config.h envelope.h expand.h ll.h ml.h mx.h queue.h red.h simta.h simta_ldap.h
simta_ldap.o: argcargv.h config.h dn.h envelope.h expand.h header.h ll.h queue.h simta.h simta_ldap.h
sla.o: config.h envelope.h expand.h line_file.h ll.h queue.h simta.h
smtp.o: argcargv.h config.h envelope.h header.h line_file.h mx.h queue.h simta.h smtp.h
simconnect.o: argcargv.h config.h envelope.h header.h line_file.h mx.h queue.h simta.h smtp.h
tls.o: config.h tls.h
wildcard.o: config.h wildcard.h

FRC :

stamp-libsnet :
	cd libsnet; ${MAKE} ${MFLAGS} CC=${CC} DEFS="${DEFS}" \
		INCPATH="${INCPATH}"
	@touch stamp-libsnet

stamp-denser :
	cd denser; ${MAKE} ${MFLAGS} CC=${CC} INCPATH="${INCPATH}"
	@touch stamp-denser

denser/dense : stamp-denser
	@true

DISTDIR=@PACKAGE_NAME@-@PACKAGE_VERSION@

dist : clean
	mkdir -p ${DESTDIR}dist/${DISTDIR}
	tar -c -f - -X .distignore . | tar xpf - -C ${DESTDIR}dist/${DISTDIR}
	cd ${DESTDIR}dist; tar cfz ${DISTDIR}.tar.gz ${DISTDIR}

rpm : dist
	rpmbuild -ta ${DESTDIR}dist/${DISTDIR}.tar.gz

clean :
	rm -f stamp-libsnet stamp-denser
	cd denser; ${MAKE} ${MFLAGS} clean
	cd libsnet; ${MAKE} ${MFLAGS} clean
	rm -f a.out core* *.o *.bak *[Ee]rrs tags
	rm -f ${TARGETS}
	rm -f simlog

realclean : clean
	rm -rf autom4te.cache
	rm -f config.status config.log config.h
	rm -f Makefile
	cd libsnet; ${MAKE} ${MFLAGS} distclean
	cd denser; ${MAKE} ${MFLAGS} realclean

tags : ${SRC}
	cwd=`pwd`; \
	for i in ${SRC}; do \
	    ctags -t -a -f ${TAGSFILE} $$cwd/$$i; \
	done

depend :
	echo for now, no...
#	for i in ${SRC} ; do \
#	    echo ${CC} -M ${DEFS} ${INCPATH} $$i
#	done
#makedep; done
#| \
#	    awk ' { if ($$1 != prev) { print rec; rec = $$0; prev = $$1; } \
#		else { if (length(rec $$2) > 78) { print rec; rec = $$0; } \
#		else rec = rec " " $$2 } } \
#		END { print rec } ' >>
#	sed -n '1,/^# DO NOT DELETE THIS LINE/p' Makefile > Makefile.tmp
#	cat makedep >> Makefile.tmp
#	rm makedep
#	echo '# DEPENDENCIES MUST END AT END OF FILE' >> Makefile.tmp
#	echo '# IF YOU PUT STUFF HERE IT WILL GO AWAY' >> Makefile.tmp
#	echo '# see make depend above' >> Makefile.tmp
#	rm -f Makefile.bak
#	cp Makefile Makefile.bak
#	mv Makefile.tmp Makefile

# DO NOT DELETE THIS LINE
